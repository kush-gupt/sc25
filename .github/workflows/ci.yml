name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_REPO: ghcr.io/${{ github.repository_owner }}/hpc-mcp-server

jobs:
  build-and-test:
    name: Build Unified Image and Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Podman + tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y podman python3-venv shellcheck
          podman --version

      - name: Build image
        run: |
          cd mcp-servers/hpc_mcp_server
          podman build \
            -t ${{ env.IMAGE_REPO }}:${{ github.sha }} \
            -f Containerfile \
            .

      - name: Run Python tests
        run: |
          cd mcp-servers/hpc_mcp_server
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -e . pytest
          pytest -q

      - name: Test build script
        run: |
          cd mcp-servers
          chmod +x build.sh
          REGISTRY=localhost TAG=test BUILDER=podman ./build.sh

      - name: Log in to GHCR (Podman)
        if: github.event_name != 'pull_request'
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login ${{ env.REGISTRY }} --username "${{ github.actor }}" --password-stdin

      - name: Push image (main only)
        if: github.event_name != 'pull_request' && github.ref == 'refs/heads/main'
        run: |
          podman push ${{ env.IMAGE_REPO }}:${{ github.sha }}
          podman tag ${{ env.IMAGE_REPO }}:${{ github.sha }} ${{ env.IMAGE_REPO }}:latest
          podman push ${{ env.IMAGE_REPO }}:latest

      - name: Lint shell scripts
        run: |
          find . -name "*.sh" -type f ! -path "./.*" | while read -r script; do
            shellcheck -x "$script" || true
          done

  test-hpc-mcp:
    name: End-to-End Cluster Test
    needs: build-and-test
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      CLUSTER_NAME: hpc-local
      HPCMCP_NAMESPACE: hpc-mcp
      KIND_EXPERIMENTAL_PROVIDER: podman

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y podman jq
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.30.0/kind-linux-amd64
          chmod +x ./kind && sudo mv ./kind /usr/local/bin/
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Disable docker CLI (prefer Podman)
        run: |
          if command -v docker >/dev/null 2>&1; then
            sudo mv "$(command -v docker)" /usr/local/bin/docker.disabled
          fi

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost
          podman system prune -af || true

      - name: Bootstrap Slurm + Flux cluster
        run: |
          cd bootstrap
          chmod +x setup_local_cluster.sh
          INSTALL_SLURM=true \
          INSTALL_FLUX=true \
          ENABLE_ACCOUNTING=false \
          ENABLE_ROOT_SSH=false \
          ENABLE_SSSD=false \
          INSTALL_ARGOCD=true \
          timeout 25m ./setup_local_cluster.sh

      - name: Build image
        run: |
          cd mcp-servers/hpc_mcp_server
          podman build -t localhost/hpc-mcp-server:latest -f Containerfile .

      - name: Load image into kind
        run: |
          podman save -o /tmp/hpc-mcp-server.tar localhost/hpc-mcp-server:latest
          kind load image-archive --name "${CLUSTER_NAME}" /tmp/hpc-mcp-server.tar

      - name: Deploy MCP server overlay
        run: |
          kubectl apply -k manifests/hpc-mcp-server/overlays/local
          kubectl wait --for=condition=Available deployment/hpc-mcp-server -n "${HPCMCP_NAMESPACE}" --timeout=180s
          kubectl wait --for=condition=Ready pod -l app=hpc-mcp-server -n "${HPCMCP_NAMESPACE}" --timeout=180s

      - name: Run integration test
        run: |
          chmod +x mcp-servers/tests/integration_test.sh
          ./mcp-servers/tests/integration_test.sh

      - name: Gather diagnostics on failure
        if: failure()
        run: |
          kubectl get pods --all-namespaces
          kubectl describe pods -n "${HPCMCP_NAMESPACE}"
          kubectl logs -n "${HPCMCP_NAMESPACE}" -l app=hpc-mcp-server || true
